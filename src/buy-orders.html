<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Rebalancing - Buy Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-spin {
            animation: spin 1s linear infinite;
        }

        /* Compact Layout Overrides - Apply only to specific content areas, not navigation */
        .content-area .text-xs { font-size: 0.6rem; line-height: 0.75rem; }
        .content-area .text-sm { font-size: 0.65rem; line-height: 0.85rem; }
        .content-area .text-base { font-size: 0.75rem; line-height: 0.95rem; }
        .content-area .text-lg { font-size: 0.8rem; line-height: 1rem; }
        .content-area .text-xl { font-size: 0.85rem; line-height: 1.1rem; }
        .content-area .text-2xl { font-size: 0.95rem; line-height: 1.2rem; }
        .content-area .text-3xl { font-size: 1.1rem; line-height: 1.3rem; }
        .content-area .text-4xl { font-size: 1.25rem; line-height: 1.4rem; }
        
        .content-area .p-2 { padding: 0.35rem; }
        .content-area .p-3 { padding: 0.5rem; }
        .content-area .p-4 { padding: 0.6rem; }
        .content-area .p-6 { padding: 0.8rem; }
        .content-area .p-8 { padding: 1rem; }
        
        .content-area .py-1 { padding-top: 0.15rem; padding-bottom: 0.15rem; }
        .content-area .py-2 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .content-area .py-3 { padding-top: 0.4rem; padding-bottom: 0.4rem; }
        .content-area .py-4 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .content-area .py-8 { padding-top: 1rem; padding-bottom: 1rem; }
        
        .content-area .px-3 { padding-left: 0.4rem; padding-right: 0.4rem; }
        .content-area .px-4 { padding-left: 0.6rem; padding-right: 0.6rem; }
        .content-area .px-6 { padding-left: 0.8rem; padding-right: 0.8rem; }
        
        .content-area .mb-2 { margin-bottom: 0.3rem; }
        .content-area .mb-3 { margin-bottom: 0.5rem; }
        .content-area .mb-4 { margin-bottom: 0.6rem; }
        .content-area .mb-6 { margin-bottom: 0.8rem; }
        .content-area .mb-8 { margin-bottom: 1rem; }
        
        .content-area .mt-1 { margin-top: 0.15rem; }
        .content-area .mt-2 { margin-top: 0.3rem; }
        .content-area .mt-4 { margin-top: 0.6rem; }
        .content-area .mt-8 { margin-top: 1rem; }
        
        .content-area .gap-4 { gap: 0.6rem; }
        .content-area .gap-8 { gap: 1rem; }
        
        .content-area .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.6rem; }
        
        /* Table specific compact styling */
        .content-area table th, .content-area table td { 
            padding: 0.4rem 0.6rem !important; 
            font-size: 0.65rem !important;
            line-height: 0.85rem !important;
        }
        
        /* Button compact styling - exclude navigation */
        .content-area button:not(nav button) { 
            padding: 0.4rem 0.8rem !important; 
            font-size: 0.7rem !important;
        }
        
        /* Input compact styling */
        .content-area input, .content-area select { 
            padding: 0.35rem !important; 
            font-size: 0.65rem !important;
        }
        
        /* Reduce card padding */
        .content-area .rounded-xl { padding: 0.8rem !important; }

        /* Navigation Styles - Full sized, professional appearance */
        .nav-link {
            position: relative;
            overflow: hidden;
            min-height: 2.5rem;
            display: flex !important;
            align-items: center !important;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav-link:hover::before {
            left: 100%;
        }

        /* Page Header - Exclude from compact styling */
        .page-header h1 {
            font-size: 1.875rem !important; /* text-3xl */
            line-height: 2.25rem !important;
        }
        
        @media (min-width: 768px) {
            .page-header h1 {
                font-size: 2.25rem !important; /* md:text-4xl */
                line-height: 2.5rem !important;
            }
        }
        
        .page-header p {
            font-size: 1rem !important; /* text-md */
            line-height: 1.5rem !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 mb-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Brand -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="AWM-Logo.png" alt="AWM Portfolio Rebalancer" class="h-8 w-auto mr-3">
                        </div>
                    </div>
                    
                    <!-- Navigation Links -->
                    <div class="hidden md:flex items-center">
                        <div class="flex items-center space-x-6">
                            <a href="index.html" class="nav-link text-gray-600 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Tax Harvesting
                            </a>
                            <a href="model-portfolios.html" class="nav-link text-gray-600 hover:text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Model Portfolios
                            </a>
                            <a href="buy-orders.html" class="nav-link bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center hover:bg-green-200 transition-colors duration-200 whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Buy Orders
                            </a>
                            <a href="price-manager.html" class="nav-link text-gray-600 hover:text-teal-600 hover:bg-teal-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Price Manager
                            </a>
                            <a href="report.html" class="nav-link text-gray-600 hover:text-orange-600 hover:bg-orange-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Reports
                            </a>
                        </div>
                    </div>
                    
                    <!-- Mobile menu button -->
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="text-gray-600 hover:text-gray-900 focus:outline-none focus:text-gray-900 p-2 rounded-md hover:bg-gray-100 transition-colors duration-200">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile menu -->
                <div id="mobile-menu" class="md:hidden hidden transition-all duration-300 ease-in-out">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-gray-50 rounded-lg mt-2 shadow-lg border border-gray-200">
                        <a href="index.html" class="mobile-nav-link text-gray-600 hover:text-blue-600 hover:bg-blue-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Tax Harvesting
                        </a>
                        <a href="model-portfolios.html" class="mobile-nav-link text-gray-600 hover:text-purple-600 hover:bg-purple-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Model Portfolios
                        </a>
                        <a href="buy-orders.html" class="mobile-nav-link bg-green-100 text-green-700 block px-3 py-2 rounded-md text-base font-medium hover:bg-green-200 transition-colors duration-200">
                            Buy Orders
                        </a>
                        <a href="price-manager.html" class="mobile-nav-link text-gray-600 hover:text-teal-600 hover:bg-teal-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Price Manager
                        </a>
                        <a href="report.html" class="mobile-nav-link text-gray-600 hover:text-orange-600 hover:bg-orange-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Reports
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="content-area">
        <div class="mb-6">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                        </svg>
                        <a href="index.html" class="text-sm font-medium text-blue-700 hover:text-blue-900">Home</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="flex-shrink-0 w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-1 text-sm font-medium text-gray-500">Buy Orders</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <!-- Page Header -->
        <div class="text-center mb-8 page-header">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Portfolio Rebalancing - Buy Orders</h1>
            <p class="text-md text-gray-600 mt-2">Generate buy orders to invest cash from sell orders into your target portfolio allocation.</p>
        </div>

        <!-- Wash Sale Compliance Check Section -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Wash Sale Compliance Check</h2>
                <button id="runWashSaleAnalysis" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors duration-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Analyze Wash Sale Risk
                </button>
            </div>
            
            <div id="washSaleResults" class="hidden">
                <!-- Results will be populated by JavaScript -->
            </div>
            
            <div id="washSaleExplanation" class="text-sm text-gray-600 mt-4">
                <p><strong>About Wash Sale Detection:</strong> This analysis compares your sell orders (tax-loss harvesting) with your proposed buy orders to identify potential IRS Section 1091 violations. The system uses a 4-tier risk classification based on ETF similarity scoring as outlined in our compliance framework.</p>
                
                <!-- Enhanced ETF Database Information -->
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center mb-2">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <h3 class="font-medium text-blue-800">Enhanced ETF Database</h3>
                    </div>
                    <p class="text-blue-700 text-xs mb-2">This tool uses a comprehensive database of 150+ ETFs to analyze potential wash sale violations with enhanced accuracy.</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="font-medium text-blue-700">50% Weight</span>
                            <p class="text-gray-600">Underlying Index</p>
                        </div>
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="font-medium text-blue-700">20% Weight</span>
                            <p class="text-gray-600">Asset Class</p>
                        </div>
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="font-medium text-blue-700">15% Weight</span>
                            <p class="text-gray-600">Management Style</p>
                        </div>
                        <div class="bg-white p-2 rounded border border-blue-100">
                            <span class="font-medium text-blue-700">15% Weight</span>
                            <p class="text-gray-600">Issuer & Other Factors</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-yellow-800 text-xs"><strong>Note:</strong> This tool provides informational analysis and risk assessment, not certified financial or tax advice. Consult a qualified professional before executing trades.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">1. Portfolio Setup</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
                        <input type="text" id="clientName" placeholder="John Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="custodian" class="block text-sm font-medium text-gray-700">Custodian</label>
                        <input type="text" id="custodian" placeholder="Fidelity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="accountNumber" class="block text-sm font-medium text-gray-700">Account Number</label>
                    <input type="text" id="accountNumber" placeholder="Enter Account Number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                </div>

                <div class="mb-4">
                    <label for="cashAvailable" class="block text-sm font-medium text-gray-700">Total Cash Available</label>
                    <input type="number" id="cashAvailable" placeholder="50000.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    <p class="text-xs text-gray-500 mt-1">Total cash from sell orders or available for investment</p>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Cash Management</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="cashReservePercent" class="block text-sm font-medium text-gray-700">Portfolio Cash Allocation % <span class="text-red-500">*</span></label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="number" id="cashReservePercent" placeholder="1.0" step="0.1" min="0" max="50" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 pr-8">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 sm:text-sm">%</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Required: % of total cash to allocate to cash position</p>
                        </div>
                        <div>
                            <label for="cashReserveDollar" class="block text-sm font-medium text-gray-700">Additional Fixed Reserve (Optional)</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" id="cashReserveDollar" placeholder="0" step="100" min="0" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 pl-7">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Optional: Additional fixed dollar amount to reserve</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Total cash reserved = Portfolio Cash Allocation % + Additional Fixed Reserve</p>
                </div>

                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label for="portfolioSelect" class="block text-sm font-medium text-gray-700">Select Model Portfolio</label>
                        <div class="flex space-x-2">
                            <button id="refreshModelsBtn" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 flex items-center">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                            <button id="createModelBtn" class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 flex items-center">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Create Model
                            </button>
                        </div>
                    </div>
                    <select id="portfolioSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 mb-3">
                        <option value="">Select a model portfolio...</option>
                    </select>
                    
                    <div class="text-center text-sm text-gray-500 mb-3">OR</div>
                    
                    <label for="portfolioFile" class="block text-sm font-medium text-gray-700 mb-2">Upload Custom Portfolio CSV</label>
                    <input type="file" id="portfolioFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors duration-200 cursor-pointer">
                    <p id="portfolio-file-name" class="text-xs text-gray-500 mt-1"></p>
                    <p class="text-xs text-gray-500 mt-2">CSV should contain: Model, Symbol, Name, Price, Target Percent</p>
                </div>
            </div>

            <!-- Generate Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">2. Generate Buy Orders</h2>
                <p class="text-sm text-gray-600 mb-4">The system will calculate whole share quantities based on your target allocation percentages.</p>
                
                <div class="flex flex-col space-y-4">
                    <button id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 shadow-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Generate Buy Orders
                    </button>
                    <button id="exportBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md flex items-center justify-center hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" />
                        </svg>
                        Export Buy Orders CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="mt-8 bg-white p-6 rounded-xl shadow-md border border-gray-200 hidden">
            <div id="loader" class="flex justify-center items-center h-40 hidden">
                <div class="loader"></div>
                <p class="ml-4 text-gray-600">Calculating optimal buy orders...</p>
            </div>
            <div id="buy-orders">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">3. Recommended Buy Orders</h2>
                <div id="summary" class="mb-6 p-4 bg-gray-100 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Target %</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Shares to Buy</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Investment Amount</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual %</th>
                            </tr>
                        </thead>
                        <tbody id="buy-orders-table" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="no-orders-msg" class="text-center text-gray-500 py-8 hidden">No buy orders generated. Please check your inputs.</p>
            </div>
        </div>
        </div> <!-- End content-area -->
    </div>

    <script>
        // --- DOM Elements ---
        const portfolioFileInput = document.getElementById('portfolioFile');
        const portfolioFileNameDisplay = document.getElementById('portfolio-file-name');
        const portfolioSelect = document.getElementById('portfolioSelect');
        const refreshModelsBtn = document.getElementById('refreshModelsBtn');
        const generateBtn = document.getElementById('generateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const buyOrdersDiv = document.getElementById('buy-orders');
        const buyOrdersTable = document.getElementById('buy-orders-table');
        const summaryDiv = document.getElementById('summary');
        const noOrdersMsg = document.getElementById('no-orders-msg');

        let portfolioData = [];
        let lastBuyOrders = [];
        let lastSummaryData = {};

        // --- Event Listeners ---
        portfolioFileInput.addEventListener('change', handlePortfolioFileUpload);
        portfolioSelect.addEventListener('change', handlePortfolioSelection);
        refreshModelsBtn.addEventListener('click', refreshModelPortfolios);
        document.getElementById('createModelBtn').addEventListener('click', createMissingModelFile);
        generateBtn.addEventListener('click', handleGeneration);
        exportBtn.addEventListener('click', handleExport);

        // Check for transferred data from tax harvesting page
        window.addEventListener('load', handleTransferredData);
        
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                
                if (mobileMenuButton && mobileMenu) {
                    mobileMenuButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        mobileMenu.classList.toggle('hidden');
                        console.log('Mobile menu toggled');
                    });
                    console.log('Mobile menu initialized successfully');
                } else {
                    console.error('Mobile menu elements not found:', {
                        button: !!mobileMenuButton,
                        menu: !!mobileMenu
                    });
                }
            } catch (error) {
                console.error('Navigation initialization error:', error);
            }
        });

        // Load model portfolios on page load with debugging info
        window.addEventListener('load', async () => {
            console.log('Buy-orders page loaded, initializing model portfolios...');
            
            // List data/models directory in console to help debug
            try {
                const testResponse = await fetch('/data/models/100-0.csv');
                console.log('Test file fetch response:', testResponse.status, testResponse.ok);
                if (testResponse.ok) {
                    console.log('Test file content available, models should load');
                }
            } catch (error) {
                console.log('Test file fetch error:', error);
            }
            
            refreshModelPortfolios();
        });

        // Check for centralized prices and show notification
        window.addEventListener('load', () => {
            const savedPrices = localStorage.getItem('centralizedPrices');
            if (savedPrices) {
                try {
                    const pricesData = JSON.parse(savedPrices);
                    const symbolCount = Object.keys(pricesData).length;
                    if (symbolCount > 0) {
                        showNotification(`Using centralized prices for ${symbolCount} symbols from Price Manager`, 'info');
                    }
                } catch (error) {
                    console.warn('Error loading centralized prices:', error);
                }
            }
        });

        // Dynamic model portfolios data - loaded from CSV files
        let modelPortfolios = {};

        // Function to load all model portfolios from data/models/ directory
        async function loadModelPortfolios() {
            // Only include files that actually exist in the data/models directory
            const modelFiles = [
                'AWM Model - All Equity.csv',
                'AWM Model - Fixed_D.csv', 
                'AWM Model - Fixed_T.csv',
                'AWM Model_Tactical Equity.csv'
            ];

            modelPortfolios = {}; // Clear existing data

            for (const filename of modelFiles) {
                try {
                    // Try multiple path formats to ensure we find the right one
                    const possiblePaths = [
                        `/data/models/${filename}`,
                        `../data/models/${filename}`,
                        `../../data/models/${filename}`,
                        `data/models/${filename}`
                    ];
                    
                    let loaded = false;
                    for (const path of possiblePaths) {
                        try {
                            console.log(`Attempting to load from path: ${path}`);
                            const response = await fetch(path);
                            console.log(`Response for ${path}:`, response.status, response.ok);
                            
                            if (response.ok) {
                                const csvText = await response.text();
                                const displayName = filename.replace('.csv', '').replace(/_/g, ' ');
                                modelPortfolios[filename] = displayName;
                                console.log(`Successfully loaded portfolio from ${path}: ${filename} -> ${displayName}`);
                                loaded = true;
                                break; // Exit the path loop once successful
                            }
                        } catch (pathError) {
                            console.log(`Path ${path} failed:`, pathError.message);
                        }
                    }
                    
                    if (!loaded) {
                        console.warn(`Failed to load ${filename} from any path`);
                    }
                } catch (error) {
                    console.warn(`Could not load model portfolio: ${filename}`, error);
                }
            }
            console.log('Final modelPortfolios:', modelPortfolios);
            return Object.keys(modelPortfolios).length > 0;
        }

        // Debug function to test loading a specific model file
        async function testLoadSpecificModel(filename) {
            try {
                // Try multiple path formats
                const possiblePaths = [
                    `/data/models/${filename}`,
                    `../data/models/${filename}`,
                    `../../data/models/${filename}`,
                    `data/models/${filename}`
                ];
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`DEBUG: Testing load of specific file: ${path}`);
                        const response = await fetch(path);
                        console.log(`DEBUG: Response for ${path}: ${response.status}, ok: ${response.ok}`);
                        
                        if (response.ok) {
                            const text = await response.text();
                            console.log(`DEBUG: File content (first 100 chars): ${text.substring(0, 100)}...`);
                            return true;
                        }
                    } catch (pathError) {
                        console.log(`DEBUG: Path ${path} failed:`, pathError.message);
                    }
                }
                
                console.error(`DEBUG: Failed to load file from any path`);
                return false;
            } catch (error) {
                console.error(`DEBUG: Error testing model load:`, error);
                return false;
            }
        }
        
        // Function to create missing model files if needed
        function createMissingModelFile() {
            // Create sample model file content
            const modelContent = `Model,Symbol,Name,Price,Target Percent
"Basic 60-40","VOO","Vanguard S&P 500 ETF",485.26,40.0
"Basic 60-40","VXF","Vanguard Extended Market ETF",172.45,10.0
"Basic 60-40","VEA","Vanguard FTSE Developed Markets ETF",50.12,10.0
"Basic 60-40","VXUS","Vanguard Total International Stock ETF",61.78,10.0
"Basic 60-40","BND","Vanguard Total Bond Market ETF",72.14,25.0
"Basic 60-40","BNDX","Vanguard Total International Bond ETF",48.76,5.0`;

            // Show a dialog to select from missing files
            const missingFiles = ['100-0.csv', '80-20.csv', 'All Equity.csv', 'Fixed-Income.csv', 'Tactical Equity.csv'];
            const selectHtml = missingFiles.map(file => 
                `<option value="${file}">${file.replace('.csv', '')}</option>`
            ).join('');
            
            const dialogHtml = `
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold mb-2">Create Missing Model File</h3>
                    <p class="mb-3">Select a model file to create:</p>
                    <select id="missing-model-select" class="w-full p-2 mb-3 border rounded">
                        ${selectHtml}
                    </select>
                    <div class="flex justify-end">
                        <button id="cancel-create-model" class="px-4 py-2 mr-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button id="confirm-create-model" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Create</button>
                    </div>
                </div>
            `;
            
            // Create and show the dialog
            const dialogOverlay = document.createElement('div');
            dialogOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialogOverlay.innerHTML = dialogHtml;
            document.body.appendChild(dialogOverlay);
            
            // Set up event handlers
            document.getElementById('cancel-create-model').addEventListener('click', () => {
                document.body.removeChild(dialogOverlay);
            });
            
            document.getElementById('confirm-create-model').addEventListener('click', async () => {
                const select = document.getElementById('missing-model-select');
                const selectedFile = select.value;
                document.body.removeChild(dialogOverlay);
                
                // Create a file for download
                const blob = new Blob([modelContent.replace(/Basic 60-40/g, selectedFile.replace('.csv', ''))], 
                    { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", selectedFile);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`Model file "${selectedFile}" created. Please save it to your data/models/ directory.`, 'success');
            });
        }

        // --- Functions ---
        async function refreshModelPortfolios() {
            const refreshIcon = refreshModelsBtn.querySelector('svg');
            const refreshText = refreshModelsBtn.querySelector('span') || refreshModelsBtn;
            
            try {
                // Show loading state
                refreshIcon.classList.add('refresh-spin');
                refreshModelsBtn.disabled = true;
                
                // Load model portfolios from CSV files
                const loadSuccess = await loadModelPortfolios();
                
                // Clear current options except the first one
                portfolioSelect.innerHTML = '<option value="">Select a model portfolio...</option>';
                
                // Add available model portfolios
                const portfolioCount = Object.keys(modelPortfolios).length;
                for (const [filename, displayName] of Object.entries(modelPortfolios)) {
                    const option = document.createElement('option');
                    option.value = filename;
                    option.textContent = displayName;
                    portfolioSelect.appendChild(option);
                }
                
                // Small delay to show the refresh animation
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (portfolioCount > 0) {
                    showNotification(`${portfolioCount} model portfolios loaded successfully`, 'success');
                } else {
                    // Try testing a specific file to debug the issue
                    const testResult = await testLoadSpecificModel('100-0.csv');
                    if (!testResult) {
                        showNotification('Could not load model portfolios. Check console for details.', 'warning');
                    } else {
                        showNotification('Model portfolios refreshed but none were found', 'warning');
                    }
                }
            } catch (error) {
                console.error('Error refreshing model portfolios:', error);
                showNotification('Error refreshing model portfolios', 'error');
            } finally {
                // Remove loading state
                refreshIcon.classList.remove('refresh-spin');
                refreshModelsBtn.disabled = false;
            }
        }

        async function handlePortfolioSelection(event) {
            const selectedFile = event.target.value;
            if (!selectedFile) {
                portfolioData = [];
                portfolioFileInput.value = '';
                portfolioFileNameDisplay.textContent = '';
                return;
            }

            try {
                // Load the selected model portfolio with multiple path options
                const possiblePaths = [
                    `/data/models/${selectedFile}`,
                    `../data/models/${selectedFile}`,
                    `../../data/models/${selectedFile}`,
                    `data/models/${selectedFile}`
                ];
                
                let response = null;
                let successPath = null;
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`Attempting to load from path: ${path}`);
                        const pathResponse = await fetch(path);
                        console.log(`Response for ${path}:`, pathResponse.status, pathResponse.ok);
                        
                        if (pathResponse.ok) {
                            response = pathResponse;
                            successPath = path;
                            break; // Exit loop once successful
                        }
                    } catch (pathError) {
                        console.log(`Path ${path} failed:`, pathError.message);
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`Failed to load ${selectedFile} from any path`);
                }
                
                const csvText = await response.text();
                console.log(`CSV content for ${selectedFile} loaded from ${successPath}:`, csvText.substring(0, 200) + '...');
                
                // Add debug logging for parsing
                try {
                    portfolioData = parsePortfolioCSVWithLogging(csvText);
                    console.log(`Successfully parsed ${portfolioData.length} positions from ${selectedFile}`);
                } catch (parseError) {
                    console.error('Error parsing CSV:', parseError);
                    throw new Error(`Could not parse CSV data: ${parseError.message}`);
                }
                
                // Clear file input and update display
                portfolioFileInput.value = '';
                portfolioFileNameDisplay.textContent = `Selected model: ${modelPortfolios[selectedFile]}`;
                
                showNotification(`Loaded model portfolio: ${modelPortfolios[selectedFile]}`, 'success');
                console.log('Loaded Model Portfolio Data:', portfolioData);
            } catch (error) {
                console.error('Error loading model portfolio:', error);
                showNotification(`Error loading model portfolio: ${error.message}`, 'error');
                portfolioSelect.value = '';
                portfolioData = [];
            }
        }

        function handlePortfolioFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                portfolioFileNameDisplay.textContent = '';
                return;
            }
            
            // Clear model portfolio selection when uploading custom file
            portfolioSelect.value = '';
            
            portfolioFileNameDisplay.textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                portfolioData = parsePortfolioCSV(e.target.result);
                console.log('Parsed Portfolio Data:', portfolioData);
            };
            reader.readAsText(file);
        }

        // Function to get centralized price for a symbol
        function getCentralizedPrice(symbol) {
            const savedPrices = localStorage.getItem('centralizedPrices');
            if (savedPrices) {
                try {
                    const pricesData = JSON.parse(savedPrices);
                    if (pricesData[symbol] && pricesData[symbol].price > 0) {
                        return pricesData[symbol].price;
                    }
                } catch (error) {
                    console.warn('Error loading centralized prices:', error);
                }
            }
            return null;
        }

        function parsePortfolioCSV(csvText) {
            // Remove BOM character if present
            csvText = csvText.replace(/^\uFEFF/, '');
            
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            console.log('CSV Header:', header);
            
            // Find column indices with more flexible matching
            const symbolIndex = header.findIndex(h => h.includes('symbol') || h.includes('ticker'));
            const nameIndex = header.findIndex(h => h.includes('name') || h.includes('description') || h.includes('security'));
            const priceIndex = header.findIndex(h => h.includes('price') || h.includes('value') || h.includes('cost'));
            const targetPercentIndex = header.findIndex(h => 
                (h.includes('target') && h.includes('percent')) || 
                h.includes('weight') || 
                h.includes('allocation') || 
                h.includes('%')
            );
            
            console.log('Column indices:', { symbolIndex, nameIndex, priceIndex, targetPercentIndex });
            
            // For AWM models, priceIndex might be -1 (no price column), which is OK
            if (symbolIndex === -1 || targetPercentIndex === -1) {
                console.error('CSV parsing failed - missing required columns:', {
                    symbolIndex, nameIndex, priceIndex, targetPercentIndex,
                    headers: header
                });
                alert('CSV must contain Symbol and Weight/Target Percent columns. Check console for details.');
                return [];
            }

            return lines.slice(1).map(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return null;
                
                const values = trimmedLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const symbol = values[symbolIndex]?.trim().replace(/"/g, '');
                const name = values[nameIndex]?.trim().replace(/"/g, '') || '';
                const priceStr = priceIndex >= 0 ? values[priceIndex]?.trim().replace(/[$\s,"]/g, '') : '';
                const targetPercentStr = values[targetPercentIndex]?.trim().replace(/[%\s,"]/g, '');
                
                if (!symbol || symbol === 'Symbol') return null;
                
                let price = parseFloat(priceStr) || 0;
                
                // Use centralized price if available (this is essential for AWM models without price columns)
                const centralizedPrice = getCentralizedPrice(symbol);
                if (centralizedPrice !== null) {
                    price = centralizedPrice;
                    console.log(`Using centralized price for ${symbol}: $${price}`);
                } else if (priceIndex === -1 || price === 0) {
                    // No price in CSV and no centralized price - this will cause issues
                    console.warn(`No price available for ${symbol} - needs centralized price from Price Manager`);
                }
                
                const targetPercent = parseFloat(targetPercentStr) || 0;
                
                console.log('Parsed item:', { symbol, name, price, targetPercent });
                
                return {
                    symbol: symbol,
                    name: name,
                    price: price,
                    targetPercent: targetPercent
                };
            }).filter(item => {
                if (!item) return false;
                
                // Valid if has symbol and either has price or target percent (will warn about missing prices later)
                const isValid = item.symbol && item.symbol !== '';
                
                if (!isValid) {
                    console.warn('Filtered out invalid item:', item);
                }
                
                if (item.price === 0) {
                    console.warn('Warning: Item has no price - will need centralized pricing:', item.symbol);
                }
                
                if (item.targetPercent === 0) {
                    console.warn('Warning: Item has 0% target allocation:', item.symbol);
                }
                
                return isValid;
            });
        }

        // Add final logging to parsePortfolioCSV
        function parsePortfolioCSVWithLogging(csvText) {
            const result = parsePortfolioCSV(csvText);
            console.log('Final parsed portfolio data:', result);
            console.log('Number of valid holdings:', result.length);
            return result;
        }

        function handleTransferredData() {
            const transferData = localStorage.getItem('taxHarvestingTransfer');
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    
                    // Auto-fill the form with transferred data
                    if (data.cashFromSales) {
                        document.getElementById('cashAvailable').value = data.cashFromSales.toFixed(2);
                    }
                    if (data.clientName) {
                        document.getElementById('clientName').value = data.clientName;
                    }
                    if (data.custodian) {
                        document.getElementById('custodian').value = data.custodian;
                    }
                    if (data.accountNumber) {
                        document.getElementById('accountNumber').value = data.accountNumber;
                    }
                    
                    // Show a notification
                    showNotification(`Transferred $${data.cashFromSales.toLocaleString()} from tax harvesting sales`, 'success');
                    
                    // Clear the transfer data
                    localStorage.removeItem('taxHarvestingTransfer');
                } catch (error) {
                    console.error('Error parsing transfer data:', error);
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    ${message}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function handleModelPortfolioTransfer() {
            const transferData = localStorage.getItem('modelPortfolioTransfer');
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    
                    // Set the portfolio data
                    portfolioData = data.portfolioData;
                    
                    // Update the file display
                    portfolioFileNameDisplay.textContent = `Loaded: ${data.portfolioName} (${portfolioData.length} holdings)`;
                    
                    // Show notification
                    showNotification(`Loaded portfolio "${data.portfolioName}" from Model Portfolios`, 'success');
                    
                    // Clear the transfer data
                    localStorage.removeItem('modelPortfolioTransfer');
                } catch (error) {
                    console.error('Error parsing model portfolio transfer data:', error);
                }
            }
        }

        function calculateCashReserves(totalCash) {
            const reservePercent = parseFloat(document.getElementById('cashReservePercent').value) || 0;
            const reserveDollar = parseFloat(document.getElementById('cashReserveDollar').value) || 0;
            
            const percentReserve = (totalCash * reservePercent) / 100;
            const dollarReserve = reserveDollar;
            
            // Add both reserves together (not take the larger)
            const totalReserve = percentReserve + dollarReserve;
            
            return {
                totalReserve: totalReserve,
                percentReserve: percentReserve,
                dollarReserve: dollarReserve,
                reservePercent: reservePercent,
                availableForInvestment: Math.max(0, totalCash - totalReserve)
            };
        }

        function handleGeneration() {
            const totalCash = parseFloat(document.getElementById('cashAvailable').value);
            const reservePercent = parseFloat(document.getElementById('cashReservePercent').value);
            
            if (!totalCash || totalCash <= 0) {
                alert('Please enter a valid cash amount available for investment.');
                return;
            }
            
            if (isNaN(reservePercent) || reservePercent < 0) {
                alert('Please enter a valid Portfolio Cash Allocation percentage (0 or greater).');
                return;
            }
            
            if (portfolioData.length === 0) {
                console.error('Portfolio data is empty:', portfolioData);
                console.error('Selected portfolio:', portfolioSelect.value);
                alert('The selected model portfolio appears to be empty or invalid. This may be because all target percentages are 0%. Please check the CSV file or upload a custom portfolio with valid target percentages.');
                return;
            }
            
            // Check if all target percentages are zero
            const hasValidTargets = portfolioData.some(item => item.targetPercent > 0);
            if (!hasValidTargets) {
                alert('Warning: All target percentages in the selected portfolio are 0%. This will not generate any buy orders. Please select a different portfolio or upload a custom CSV with valid target percentages.');
                return;
            }
            
            // Check for missing prices
            const itemsWithoutPrices = portfolioData.filter(item => item.price === 0 || !item.price);
            if (itemsWithoutPrices.length > 0) {
                const symbolsWithoutPrices = itemsWithoutPrices.map(item => item.symbol).join(', ');
                alert(`Warning: The following symbols have no prices: ${symbolsWithoutPrices}. Please use the Price Manager to set centralized prices, or upload a portfolio CSV that includes prices.`);
                return;
            }
            
            console.log('Portfolio data loaded successfully:', portfolioData.length, 'holdings');
            
            // Calculate cash reserves
            const reserves = calculateCashReserves(totalCash);
            const cashAvailable = reserves.availableForInvestment;
            
            if (cashAvailable <= 0) {
                alert('No cash available for investment after reserves. Please reduce your cash reserve amounts.');
                return;
            }
            
            // Validate that target percentages add up to reasonable amount
            const totalTargetPercent = portfolioData.reduce((sum, item) => sum + item.targetPercent, 0);
            if (totalTargetPercent < 90 || totalTargetPercent > 110) {
                alert(`Warning: Target percentages sum to ${totalTargetPercent.toFixed(1)}%. Expected around 100%.`);
            }
            
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            buyOrdersDiv.classList.add('hidden');
            exportBtn.classList.add('hidden');

            setTimeout(() => {
                lastBuyOrders = generateBuyOrders(cashAvailable, reserves);
                displayBuyOrders(lastBuyOrders, totalCash, reserves);
                loader.classList.add('hidden');
                buyOrdersDiv.classList.remove('hidden');
                if(lastBuyOrders.length > 0) {
                    exportBtn.classList.remove('hidden');
                    // Auto-save data for report
                    saveBuyOrdersReportData();
                }
            }, 500);
        }

        function generateBuyOrders(cashAvailable, reserves) {
            const buyOrders = [];
            let remainingCash = cashAvailable;
            let totalInvested = 0;
            
            // Sort by target percentage descending to prioritize larger allocations
            const sortedPortfolio = [...portfolioData].sort((a, b) => b.targetPercent - a.targetPercent);
            
            // First pass: calculate target amounts and whole shares
            for (const item of sortedPortfolio) {
                const targetAmount = (cashAvailable * item.targetPercent) / 100;
                const wholeSharesToBuy = Math.floor(targetAmount / item.price);
                const actualInvestment = wholeSharesToBuy * item.price;
                
                if (wholeSharesToBuy > 0 && actualInvestment <= remainingCash) {
                    const actualPercent = (actualInvestment / cashAvailable) * 100;
                    
                    buyOrders.push({
                        symbol: item.symbol,
                        name: item.name,
                        price: item.price,
                        targetPercent: item.targetPercent,
                        sharesToBuy: wholeSharesToBuy,
                        investmentAmount: actualInvestment,
                        actualPercent: actualPercent
                    });
                    
                    remainingCash -= actualInvestment;
                    totalInvested += actualInvestment;
                }
            }
            
            // Second pass: try to use remaining cash for additional shares
            if (remainingCash > 0) {
                for (const order of buyOrders) {
                    const additionalShares = Math.floor(remainingCash / order.price);
                    if (additionalShares > 0) {
                        const additionalInvestment = additionalShares * order.price;
                        order.sharesToBuy += additionalShares;
                        order.investmentAmount += additionalInvestment;
                        order.actualPercent = (order.investmentAmount / cashAvailable) * 100;
                        remainingCash -= additionalInvestment;
                        totalInvested += additionalInvestment;
                        
                        if (remainingCash < Math.min(...portfolioData.map(p => p.price))) {
                            break;
                        }
                    }
                }
            }
            
            lastSummaryData = {
                totalInvested,
                remainingCash,
                cashAvailable,
                orderCount: buyOrders.length,
                reserves: reserves
            };
            
            return buyOrders;
        }

        function displayBuyOrders(buyOrders, totalCash, reserves) {
            buyOrdersTable.innerHTML = '';
            noOrdersMsg.classList.toggle('hidden', buyOrders.length > 0);

            const formatCurrency = (num) => num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            const formatPercent = (num) => num.toFixed(2) + '%';

            buyOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">BUY</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.symbol}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${formatCurrency(order.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatPercent(order.targetPercent)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900">${order.sharesToBuy.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-green-600">${formatCurrency(order.investmentAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${formatPercent(order.actualPercent)}</td>
                `;
                buyOrdersTable.appendChild(row);
            });

            // Update summary
            const { totalInvested, remainingCash, orderCount } = lastSummaryData;
            const cashAvailable = reserves.availableForInvestment;
            const utilizationPercent = (totalInvested / cashAvailable) * 100;
            const totalRemainingCash = remainingCash + reserves.totalReserve;

            let summaryHTML = `
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Cash Available</p>
                    <p class="text-xl font-bold text-gray-800">${formatCurrency(totalCash)}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Invested</p>
                    <p class="text-xl font-bold text-green-600">${formatCurrency(totalInvested)}</p>
                    <p class="text-xs text-gray-500">(${orderCount} orders)</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Cash Remaining</p>
                    <p class="text-xl font-bold ${totalRemainingCash > 1000 ? 'text-blue-600' : 'text-gray-600'}">${formatCurrency(totalRemainingCash)}</p>
                    <p class="text-xs text-gray-500">(${utilizationPercent.toFixed(1)}% of investable cash used)</p>
                </div>
            `;

            // Add reserve breakdown if reserves are set
            if (reserves.totalReserve > 0) {
                summaryHTML += `
                    <div class="col-span-full mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">Cash Reserve Breakdown:</h4>
                        <div class="grid grid-cols-2 gap-4 text-xs text-blue-700">
                            <div>
                                <span class="font-medium">Portfolio Cash Allocation:</span> ${formatCurrency(reserves.percentReserve)} (${reserves.reservePercent}%)
                                ${reserves.dollarReserve > 0 ? `<br><span class="font-medium">Additional Fixed Reserve:</span> ${formatCurrency(reserves.dollarReserve)}` : ''}
                            </div>
                            <div>
                                <span class="font-medium">Total Reserved:</span> ${formatCurrency(reserves.totalReserve)}<br>
                                <span class="font-medium">Uninvested:</span> ${formatCurrency(remainingCash)}
                            </div>
                        </div>
                    </div>
                `;
            }

            summaryDiv.innerHTML = summaryHTML;
        }

        function handleExport() {
            if (lastBuyOrders.length === 0) {
                alert("No buy orders to export.");
                return;
            }

            // Save data for report
            saveBuyOrdersReportData();

            const accountNumber = document.getElementById('accountNumber').value || 'N/A';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const custodian = document.getElementById('custodian').value || 'N/A';
            
            const headers = [
                "Account Number", "Client Name", "Custodian", "Action", "Symbol", 
                "Security Name", "Quantity", "Price", "Total Investment", 
                "Target Percent", "Actual Percent", "Cash Reserves", "Remaining Cash"
            ];

            const { reserves } = lastSummaryData;
            const rows = lastBuyOrders.map((order, index) => {
                return [
                    accountNumber,
                    `"${clientName}"`,
                    `"${custodian}"`,
                    "Buy",
                    `"${order.symbol}"`,
                    `"${order.name}"`,
                    order.sharesToBuy,
                    order.price.toFixed(2),
                    order.investmentAmount.toFixed(2),
                    order.targetPercent.toFixed(2),
                    order.actualPercent.toFixed(2),
                    index === 0 ? reserves.totalReserve.toFixed(2) : '', // Only show reserves on first row
                    index === 0 ? lastSummaryData.remainingCash.toFixed(2) : '' // Only show remaining cash on first row
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `buy_orders_${accountNumber}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveBuyOrdersReportData() {
            const totalCash = parseFloat(document.getElementById('cashAvailable').value) || 0;
            const { totalInvested, remainingCash, reserves } = lastSummaryData;

            // Determine portfolio source
            let portfolioSource = 'None';
            let portfolioName = '';
            
            if (portfolioData.length > 0) {
                const selectedPortfolio = portfolioSelect.value;
                if (selectedPortfolio) {
                    portfolioSource = 'Model Portfolio';
                    portfolioName = modelPortfolios[selectedPortfolio] || selectedPortfolio;
                } else {
                    portfolioSource = 'Custom Upload';
                    portfolioName = portfolioFileNameDisplay.textContent.replace('Selected: ', '') || 'Custom Portfolio';
                }
            }

            const reportData = {
                totalCash: totalCash,
                totalInvested: totalInvested,
                remainingCash: remainingCash,
                reserves: reserves,
                orders: lastBuyOrders,
                portfolioSource: portfolioSource,
                portfolioName: portfolioName,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('buyOrdersReport', JSON.stringify(reportData));
        }
        
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                
                if (mobileMenuButton && mobileMenu) {
                    mobileMenuButton.addEventListener('click', function() {
                        mobileMenu.classList.toggle('hidden');
                    });
                    
                    // Close mobile menu when clicking outside
                    document.addEventListener('click', function(event) {
                        if (!mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                            mobileMenu.classList.add('hidden');
                        }
                    });
                }
                
                // Handle navigation links
                const navLinks = document.querySelectorAll('a[href]');
                navLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        const href = this.getAttribute('href');
                        if (href && href !== '#') {
                            console.log('Navigating to:', href);
                            // Let the browser handle the navigation normally
                        }
                    });
                });
                
            } catch (error) {
                console.error('Navigation initialization error:', error);
            }
        });

        // =================================
        // WASH SALE DETECTION SYSTEM
        // Based on Framework: A Framework for an Automated Wash Sale Avoidance and Portfolio Rebalancing System
        // =================================

        // Enhanced ETF Database using ETF-Wash-Sale-Database_08-01-2025.csv
        let etfDatabase = {};
        
        // Function to load ETF database from CSV file
        async function loadETFDatabase() {
            try {
                const response = await fetch('/data/etf-database/ETF-Wash-Sale-Database_08-01-2025.csv');
                const csvData = await response.text();
                const rows = csvData.split('\n');
                const headers = rows[0].split(',');
                
                // Skip header row and process each ETF
                for (let i = 1; i < rows.length; i++) {
                    if (!rows[i].trim()) continue; // Skip empty rows
                    
                    const values = rows[i].split(',');
                    const symbol = values[0].trim();
                    
                    if (symbol) {
                        etfDatabase[symbol] = {
                            name: values[1].trim(),
                            issuer: values[2].trim(),
                            assetClass: values[3].trim(),
                            category: values[4].trim(),
                            managementStyle: values[5].trim(),
                            index: values[6].trim() || 'N/A', // Use index/benchmark as primary similarity factor
                            expenseRatio: parseFloat(values[7]) || 0,
                            aum: values[8].trim(), // Assets Under Management
                            avgDailyVolume: parseInt(values[9]) || 0
                        };
                    }
                }
                
                console.log(`ETF Database loaded: ${Object.keys(etfDatabase).length} ETFs`);
                return true;
            } catch (error) {
                console.error('Error loading ETF database:', error);
                // Fallback to static database if loading fails
                initializeStaticETFDatabase();
                return false;
            }
        }
        
        // Fallback static database with key ETFs (will be used if CSV loading fails)
        function initializeStaticETFDatabase() {
            console.warn('Using fallback static ETF database');
            
            etfDatabase = {
                // S&P 500 Family - High Risk Tier 1
                'IVV': { name: 'iShares Core S&P 500 ETF', index: 'S&P 500', assetClass: 'US Equity', category: 'Large Cap Blend', managementStyle: 'Passive', issuer: 'iShares' },
                'VOO': { name: 'Vanguard S&P 500 ETF', index: 'S&P 500', assetClass: 'US Equity', category: 'Large Cap Blend', managementStyle: 'Passive', issuer: 'Vanguard' },
                'SPY': { name: 'SPDR S&P 500 ETF Trust', index: 'S&P 500', assetClass: 'US Equity', category: 'Large Cap Blend', managementStyle: 'Passive', issuer: 'State Street' },
                
                // Total Market - Tier 3
                'VTI': { name: 'Vanguard Total Stock Market ETF', index: 'CRSP US Total Market', assetClass: 'US Equity', category: 'Large Cap Blend', managementStyle: 'Passive', issuer: 'Vanguard' },
                'ITOT': { name: 'iShares Core S&P Total US Stock Market ETF', index: 'S&P Total Market', assetClass: 'US Equity', category: 'Large Cap Blend', managementStyle: 'Passive', issuer: 'iShares' },
                
                // International
                'VEA': { name: 'Vanguard FTSE Developed Markets ETF', index: 'FTSE Developed All Cap ex US', assetClass: 'International Equity', category: 'Foreign Large Blend', managementStyle: 'Passive', issuer: 'Vanguard' },
                'IEFA': { name: 'iShares Core MSCI EAFE ETF', index: 'MSCI EAFE IMI', assetClass: 'International Equity', category: 'Foreign Large Blend', managementStyle: 'Passive', issuer: 'iShares' },
                
                // Fixed Income
                'AGG': { name: 'iShares Core U.S. Aggregate Bond ETF', index: 'Bloomberg US Aggregate Bond Index', assetClass: 'Fixed Income', category: 'Intermediate Core Bond', managementStyle: 'Passive', issuer: 'iShares' },
                'BND': { name: 'Vanguard Total Bond Market ETF', index: 'Bloomberg US Aggregate Float Adjusted Index', assetClass: 'Fixed Income', category: 'Intermediate Core Bond', managementStyle: 'Passive', issuer: 'Vanguard' }
            };
        }
        
        // Initialize database loading
        loadETFDatabase().then(success => {
            if (!success) {
                console.warn('Using fallback static ETF database due to loading failure');
            }
        });

        // Enhanced Multi-Factor Similarity Scoring System (Based on ETF-Wash-Sale-Database document)
        function calculateSimilarityScore(symbol1, symbol2) {
            const etf1 = etfDatabase[symbol1];
            const etf2 = etfDatabase[symbol2];
            
            if (!etf1 || !etf2) return 0; // Unknown ETFs get 0 score
            if (symbol1 === symbol2) return 100; // Same ETF
            
            let score = 0;
            let reasonsForScore = [];
            
            // 1. Underlying Index/Benchmark (Weight: 50%) - Most important factor per documentation
            if (etf1.index === etf2.index && etf1.index !== 'N/A') {
                score += 50;
                reasonsForScore.push(`Identical underlying index: ${etf1.index}`);
            } else if (etf1.index && etf2.index) {
                // Check for related indexes within same families
                if (etf1.index.includes('S&P 500') && etf2.index.includes('S&P 500')) {
                    score += 40;
                    reasonsForScore.push('Related S&P 500 index variants');
                } else if (etf1.index.includes('Russell') && etf2.index.includes('Russell')) {
                    score += 30;
                    reasonsForScore.push('Related Russell index variants');
                } else if (etf1.index.includes('MSCI') && etf2.index.includes('MSCI')) {
                    score += 30;
                    reasonsForScore.push('Related MSCI index variants');
                } else if (etf1.index.includes('FTSE') && etf2.index.includes('FTSE')) {
                    score += 30;
                    reasonsForScore.push('Related FTSE index variants');
                } else if (etf1.index.includes('Bloomberg') && etf2.index.includes('Bloomberg')) {
                    score += 25;
                    reasonsForScore.push('Related Bloomberg index variants');
                }
            }
            
            // 2. Asset Class & Category (Weight: 20%)
            if (etf1.assetClass === etf2.assetClass && etf1.category === etf2.category) {
                score += 20;
                reasonsForScore.push(`Identical asset class and category: ${etf1.assetClass}, ${etf1.category}`);
            } else if (etf1.assetClass === etf2.assetClass) {
                score += 10;
                reasonsForScore.push(`Same asset class: ${etf1.assetClass}`);
            }
            
            // 3. Management Style (Weight: 15%)
            if (etf1.managementStyle === etf2.managementStyle) {
                score += 15;
                reasonsForScore.push(`Same management style: ${etf1.managementStyle}`);
            } else if (etf1.managementStyle === 'Passive' && etf2.managementStyle === 'Passive') {
                // Passive-to-passive transitions particularly susceptible to wash sales
                score += 15;
                reasonsForScore.push('Both use passive management style');
            } else if (etf1.managementStyle === 'Active' && etf2.managementStyle === 'Active') {
                score += 10;
                reasonsForScore.push('Both use active management style');
            }
            
            // 4. Different Issuer (Weight: 10%) - Different issuers can help reduce similarity
            if (etf1.issuer !== etf2.issuer) {
                score -= 10;
                reasonsForScore.push(`Different issuers: ${etf1.issuer} vs ${etf2.issuer}`);
            } else {
                score += 5;
                reasonsForScore.push(`Same issuer: ${etf1.issuer}`);
            }
            
            // 5. AUM and Expense Ratio bonuses/penalties (Weight: 5%)
            // Similar expense ratios may indicate similar investment approaches
            if (etf1.expenseRatio && etf2.expenseRatio) {
                const expenseDiff = Math.abs(etf1.expenseRatio - etf2.expenseRatio);
                if (expenseDiff < 0.1) {
                    score += 5;
                    reasonsForScore.push('Similar expense ratios');
                }
            }
            
            // Final score capped at 100
            const finalScore = Math.max(0, Math.min(100, score));
            
            // Log detailed scoring information for significant similarities (debug only)
            if (finalScore > 50) {
                console.debug(`Similarity analysis for ${symbol1} vs ${symbol2}: Score ${finalScore}%`, reasonsForScore);
            }
            
            return finalScore;
        }

        // Enhanced Risk Tier Classification with detailed descriptions
        function getSimilarityRiskTier(score) {
            if (score >= 90) {
                return { 
                    tier: 1, 
                    level: 'High Risk', 
                    color: 'red', 
                    description: 'Presumed Identical - Likely Wash Sale',
                    explanation: 'These ETFs are substantially identical per IRS Section 1091 criteria. If sold at a loss and repurchased within 61 days (30 days before or after the sale), the loss will likely be disallowed.'
                };
            } 
            
            if (score >= 65) {
                return { 
                    tier: 2, 
                    level: 'Moderate Risk', 
                    color: 'orange', 
                    description: 'User Warning - Potential Risk',
                    explanation: 'These ETFs share significant similarities that could potentially trigger IRS scrutiny. Consider alternative investments if the original position was sold at a loss within the past 30 days.'
                };
            }
            
            if (score >= 30) {
                return { 
                    tier: 3, 
                    level: 'Low Risk', 
                    color: 'yellow', 
                    description: 'Generally Acceptable',
                    explanation: 'These ETFs have some similarities but would generally be considered different enough to avoid wash sale treatment. However, consider your specific tax situation before proceeding.'
                };
            }
            
            return { 
                tier: 4, 
                level: 'Not Substantially Identical', 
                color: 'green', 
                description: 'Safe Alternative',
                explanation: 'These ETFs are sufficiently different in their underlying securities, investment objectives, or other key characteristics to avoid wash sale concerns.'
            };
        }

        // Alternative Recommendation Engine (Section 4.2 of framework)
        // Enhanced Alternative Recommendation Engine
        function findWashSaleAlternatives(originalSymbol, targetAssetClass, targetStyle) {
            const alternatives = [];
            const originalETF = etfDatabase[originalSymbol];
            
            if (!originalETF) {
                console.warn(`Cannot find alternatives for unknown ETF: ${originalSymbol}`);
                return alternatives;
            }
            
            // Use provided target class/category or fall back to original ETF's values
            const searchAssetClass = targetAssetClass || originalETF.assetClass;
            const searchCategory = targetStyle || (originalETF.category || originalETF.style);
            
            console.log(`Finding alternatives for ${originalSymbol} (${originalETF.name}) - Asset Class: ${searchAssetClass}, Category: ${searchCategory}`);
            
            // First pass - find all potential alternatives in the same asset class/category
            const potentialAlternatives = [];
            
            for (const [symbol, etf] of Object.entries(etfDatabase)) {
                if (symbol === originalSymbol) continue;
                
                // Prioritize ETFs in the same asset class and category first
                if (etf.assetClass === searchAssetClass) {
                    const similarityScore = calculateSimilarityScore(originalSymbol, symbol);
                    const riskTier = getSimilarityRiskTier(similarityScore);
                    
                    // Only consider safe alternatives (tier 3 or 4)
                    if (riskTier.tier >= 3) {
                        potentialAlternatives.push({
                            symbol,
                            name: etf.name,
                            issuer: etf.issuer,
                            assetClass: etf.assetClass,
                            style: etf.style || etf.category,
                            index: etf.index,
                            expenseRatio: etf.expenseRatio,
                            aum: etf.aum,
                            avgDailyVolume: etf.avgDailyVolume,
                            similarityScore,
                            riskTier
                        });
                    }
                }
            }
            
            // Second pass - sort and filter the alternatives
            
            // Filter for category match if we have enough alternatives
            let filteredAlternatives = potentialAlternatives;
            const categoryMatches = potentialAlternatives.filter(alt => 
                (alt.style === searchCategory) || (alt.category === searchCategory)
            );
            
            if (categoryMatches.length >= 3) {
                filteredAlternatives = categoryMatches;
            }
            
            // Sort by multiple criteria
            filteredAlternatives.sort((a, b) => {
                // First by risk tier (safer alternatives first)
                if (b.riskTier.tier !== a.riskTier.tier) {
                    return b.riskTier.tier - a.riskTier.tier;
                }
                
                // Then by expense ratio (lower is better) if available
                if (a.expenseRatio && b.expenseRatio && a.expenseRatio !== b.expenseRatio) {
                    return a.expenseRatio - b.expenseRatio;
                }
                
                // Then by trading volume (higher is better) if available
                if (a.avgDailyVolume && b.avgDailyVolume) {
                    return b.avgDailyVolume - a.avgDailyVolume;
                }
                
                // Lastly by name
                return a.name.localeCompare(b.name);
            });
            
            // Return top alternatives (limit to 5)
            return filteredAlternatives.slice(0, 5);
        }

        // Main Wash Sale Analysis Function
        function analyzeWashSaleViolations() {
            console.log('Starting wash sale analysis with enhanced ETF database...');
            
            // Get sell orders from localStorage (from previous page)
            const sellOrders = JSON.parse(localStorage.getItem('sellOrders') || '[]');
            console.log('Retrieved sell orders from localStorage:', sellOrders);
            
            // Get proposed buy orders from current page (correct table ID)
            const buyOrderRows = document.querySelectorAll('#buy-orders-table tr');
            const buyOrders = [];
            
            buyOrderRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) { // Buy order table has 8 columns
                    // Columns: Action, Symbol, Name, Price, Target %, Shares, Investment Amount, Actual %
                    buyOrders.push({
                        symbol: cells[1].textContent.trim(), // Symbol is in 2nd column
                        name: cells[2].textContent.trim(),   // Name is in 3rd column
                        shares: parseInt(cells[5].textContent.replace(/,/g, '')), // Shares in 6th column
                        price: parseFloat(cells[3].textContent.replace(/[$,]/g, '')), // Price in 4th column
                        marketValue: parseFloat(cells[6].textContent.replace(/[$,]/g, '')) // Investment amount in 7th column
                    });
                }
            });
            
            console.log('Sell orders:', sellOrders);
            console.log('Buy orders:', buyOrders);
            
            if (sellOrders.length === 0) {
                console.warn('No sell orders found in localStorage. If you expect sell orders, make sure you generate them on the Tax Harvesting page first.');
            }
            
            if (buyOrders.length === 0) {
                console.warn('No buy orders found in the table. Please add buy orders before running wash sale analysis.');
            }
            
            const violations = [];
            
            // Step 3 of framework: Wash Sale Violation Detection Loop
            // Per IRS Section 1091, check for substantially identical securities within 61-day window
            sellOrders.forEach(sellOrder => {
                if (sellOrder.actualGain && sellOrder.actualGain < 0) { // Only check loss sales
                    buyOrders.forEach(buyOrder => {
                        const similarityScore = calculateSimilarityScore(sellOrder.symbol, buyOrder.symbol);
                        const riskTier = getSimilarityRiskTier(similarityScore);
                        
                        if (riskTier.tier <= 2) { // Tier 1 or 2 = violation risk
                            const soldETF = etfDatabase[sellOrder.symbol];
                            const purchasedETF = etfDatabase[buyOrder.symbol];
                            
                            // Get recommended alternatives
                            const alternatives = findWashSaleAlternatives(
                                buyOrder.symbol, 
                                soldETF?.assetClass || purchasedETF?.assetClass, 
                                soldETF?.category || soldETF?.style || purchasedETF?.category
                            );
                            
                            // Create comprehensive violation record
                            violations.push({
                                soldSymbol: sellOrder.symbol,
                                soldName: sellOrder.name,
                                soldLoss: sellOrder.actualGain,
                                soldShares: sellOrder.shares,
                                soldDate: sellOrder.date || 'N/A',
                                purchasedSymbol: buyOrder.symbol,
                                purchasedName: buyOrder.name,
                                purchasedAmount: buyOrder.marketValue,
                                purchasedShares: buyOrder.shares,
                                similarityScore: similarityScore,
                                riskTier: riskTier,
                                alternatives: alternatives,
                                // Include key similarity factors
                                similarityFactors: {
                                    sameIndex: soldETF && purchasedETF && soldETF.index === purchasedETF.index,
                                    sameAssetClass: soldETF && purchasedETF && soldETF.assetClass === purchasedETF.assetClass,
                                    sameIssuer: soldETF && purchasedETF && soldETF.issuer === purchasedETF.issuer,
                                    sameManagementStyle: soldETF && purchasedETF && 
                                                      soldETF.managementStyle === purchasedETF.managementStyle
                                },
                                description: `Planned purchase of ${buyOrder.shares} shares of ${buyOrder.symbol} may be substantially identical to ${sellOrder.shares} shares of ${sellOrder.symbol} sold at a loss of $${Math.abs(sellOrder.actualGain).toFixed(2)}`
                            });
                        }
                    });
                }
            });
            
            displayWashSaleResults(violations);
            
            return violations;
        }

        // Display Results Function
        function displayWashSaleResults(violations) {
            const resultsDiv = document.getElementById('washSaleResults');
            
            if (violations.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-green-800"> No Wash Sale Violations Detected</h3>
                        </div>
                        <p class="text-green-700 mt-2">Your proposed buy orders do not create any substantial similarity conflicts with your sell orders. You can proceed with confidence.</p>
                    </div>
                `;
            } else {
                let violationsHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
                        <div class="flex items-center mb-3">
                            <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-red-800"> ${violations.length} Potential Wash Sale Violation${violations.length > 1 ? 's' : ''} Detected</h3>
                        </div>
                        <p class="text-red-700 mb-4">The following buy orders may trigger IRS Section 1091 wash sale violations:</p>
                `;
                
                violations.forEach((violation, index) => {
                    const riskColor = violation.riskTier.tier <= 1 ? 'red' : 'yellow';
                    
                    // Format similarity factors
                    let factorsHTML = '';
                    if (violation.similarityFactors) {
                        factorsHTML = `
                            <div class="mt-3 p-2 bg-${riskColor}-100 rounded-lg">
                                <h5 class="font-medium text-${riskColor}-800 mb-1">Key Similarity Factors:</h5>
                                <ul class="list-disc ml-5 text-xs text-${riskColor}-700 space-y-1">
                                    ${violation.similarityFactors.sameIndex ? 
                                        `<li class="font-medium">Same underlying index (strongest factor)</li>` : ''}
                                    ${violation.similarityFactors.sameAssetClass ? 
                                        `<li>Same asset class (${violation.soldSymbol} and ${violation.purchasedSymbol})</li>` : ''}
                                    ${violation.similarityFactors.sameIssuer ? 
                                        `<li>Same issuer/provider</li>` : ''}
                                    ${violation.similarityFactors.sameManagementStyle ? 
                                        `<li>Same management style (active/passive)</li>` : ''}
                                </ul>
                            </div>
                        `;
                    }
                    
                    violationsHTML += `
                        <div class="mb-6 p-4 bg-${riskColor}-50 border border-${riskColor}-200 rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-semibold text-${riskColor}-800">Violation #${index + 1}: ${violation.soldSymbol}  ${violation.purchasedSymbol}</h4>
                                    <p class="text-sm text-${riskColor}-700">${violation.description}</p>
                                </div>
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-${riskColor}-100 text-${riskColor}-800">
                                    Tier ${violation.riskTier.tier} - ${violation.riskTier.level || violation.riskTier.description}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                                <div>
                                    <strong>Sold (Loss):</strong> ${violation.soldSymbol}${violation.soldName ? ` (${violation.soldName})` : ''}<br>
                                    <strong>Loss Amount:</strong> $${Math.abs(violation.soldLoss).toLocaleString()}<br>
                                    ${violation.soldShares ? `<strong>Shares Sold:</strong> ${violation.soldShares.toLocaleString()}<br>` : ''}
                                    ${violation.soldDate ? `<strong>Date Sold:</strong> ${violation.soldDate}` : ''}
                                </div>
                                <div>
                                    <strong>Buying:</strong> ${violation.purchasedSymbol}${violation.purchasedName ? ` (${violation.purchasedName})` : ''}<br>
                                    <strong>Buy Amount:</strong> $${violation.purchasedAmount.toLocaleString()}<br>
                                    ${violation.purchasedShares ? `<strong>Shares to Buy:</strong> ${violation.purchasedShares.toLocaleString()}` : ''}
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-${riskColor}-100 rounded-lg mb-3">
                                <div>
                                    <strong class="text-${riskColor}-800">Similarity Score:</strong> 
                                    <span class="text-lg font-bold">${(violation.similarityScore * 100).toFixed(0)}%</span>
                                </div>
                                <div class="text-xs text-${riskColor}-700">
                                    ${violation.riskTier.description}
                                </div>
                            </div>
                            
                            ${factorsHTML}
                            
                            ${violation.alternatives && violation.alternatives.length > 0 ? `
                                <div class="mt-4">
                                    <h5 class="font-medium text-${riskColor}-800 mb-2"> Recommended Safe Alternatives:</h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        ${violation.alternatives.slice(0, 4).map(alt => {
                                            // Handle both object and string formats of alternatives
                                            if (typeof alt === 'object' && alt.symbol) {
                                                return `
                                                    <div class="p-2 bg-white border border-gray-200 rounded text-xs">
                                                        <strong>${alt.symbol}</strong> - ${alt.name ? (alt.name.length > 30 ? alt.name.substring(0, 30) + '...' : alt.name) : ''}<br>
                                                        <span class="text-gray-600">${alt.assetClass || ''} ${alt.style || alt.managementStyle || ''}</span><br>
                                                        ${alt.description ? `<span class="text-gray-500">${alt.description}</span><br>` : ''}
                                                        <span class="text-green-600 font-medium"> Safe alternative</span>
                                                    </div>
                                                `;
                                            } else {
                                                return `
                                                    <div class="p-2 bg-white border border-gray-200 rounded text-xs">
                                                        <strong>${alt}</strong><br>
                                                        <span class="text-green-600 font-medium"> Safe alternative</span>
                                                    </div>
                                                `;
                                            }
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="mt-4 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-xs text-gray-700">
                                <p><strong>IRS Wash Sale Impact:</strong> If you proceed with this purchase, your loss of $${Math.abs(violation.soldLoss).toLocaleString()} may be disallowed and added to the cost basis of the new security.</p>
                            </div>
                        </div>
                    `;
                });
                
                // Add educational content about wash sales
                violationsHTML += `
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="text-blue-800 font-medium mb-2">About Wash Sale Risk Tiers:</h4>
                        <ul class="list-disc ml-5 text-sm text-blue-700 space-y-2">
                            <li><strong>Tier 1 (High Risk):</strong> Highly likely to be considered substantially identical by the IRS. ETFs sharing the same underlying index or with over 90% portfolio overlap.</li>
                            <li><strong>Tier 2 (Medium Risk):</strong> May be considered substantially identical, recommended to avoid. ETFs tracking similar indices with significant portfolio overlap.</li>
                            <li><strong>Tier 3 (Low Risk):</strong> Likely different enough to avoid wash sale rule. May share an asset class but track different indices.</li>
                            <li><strong>Tier 4 (Very Low Risk):</strong> Different enough to avoid wash sale rule. Typically different asset classes or investment approaches.</li>
                        </ul>
                        
                        <h4 class="text-blue-800 font-medium mt-4 mb-2">Similarity Scoring Factors:</h4>
                        <ul class="list-disc ml-5 text-sm text-blue-700 space-y-1">
                            <li><strong>Underlying Index (50%):</strong> The most important factor. ETFs tracking the same index are likely substantially identical.</li>
                            <li><strong>Asset Class (20%):</strong> General category like US Equity, Fixed Income, etc.</li>
                            <li><strong>Management Style (15%):</strong> Active vs. Passive management approaches</li>
                            <li><strong>Issuer (10%):</strong> The company offering the ETF (Vanguard, iShares, etc.)</li>
                            <li><strong>Other Factors (5%):</strong> Including expense ratio, assets under management, trading volume, etc.</li>
                        </ul>
                        
                        <p class="mt-4 text-sm text-blue-800 font-medium">This analysis is for informational purposes only and is not tax advice. Consult a tax professional for specific advice.</p>
                    </div>
                </div>
                `;
                resultsDiv.innerHTML = violationsHTML;
            }
            
            resultsDiv.classList.remove('hidden');
        }

        // Event Listener for Wash Sale Analysis Button
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeButton = document.getElementById('runWashSaleAnalysis');
            if (analyzeButton) {
                analyzeButton.addEventListener('click', function() {
                    console.log('Wash sale analysis button clicked');
                    analyzeWashSaleViolations();
                });
            }
        });

        // Test function to verify wash sale detection (for development/testing)
        function testWashSaleDetection() {
            console.log('Testing wash sale detection system...');
            
            // Test similarity scoring
            console.log('VOO vs SPY similarity:', calculateSimilarityScore('VOO', 'SPY')); // Should be high (same index)
            console.log('VOO vs VTI similarity:', calculateSimilarityScore('VOO', 'VTI')); // Should be moderate
            console.log('VOO vs VEA similarity:', calculateSimilarityScore('VOO', 'VEA')); // Should be low
            console.log('VOO vs BOND similarity:', calculateSimilarityScore('VOO', 'BOND')); // Should be very low
            
            // Test risk tier classification
            console.log('Risk tier for score 95:', getSimilarityRiskTier(95));
            console.log('Risk tier for score 70:', getSimilarityRiskTier(70));
            console.log('Risk tier for score 40:', getSimilarityRiskTier(40));
            console.log('Risk tier for score 10:', getSimilarityRiskTier(10));
            
            // Test with sample data
            const testSellOrders = [
                { symbol: 'SPY', actualGain: -5000, shares: 100, price: 450, marketValue: 45000 },
                { symbol: 'BOND', actualGain: -1000, shares: 50, price: 80, marketValue: 4000 }
            ];
            
            const testBuyOrders = [
                { symbol: 'VOO', shares: 100, price: 450, marketValue: 45000 },
                { symbol: 'VTI', shares: 50, price: 250, marketValue: 12500 },
                { symbol: 'BINC', shares: 100, price: 50, marketValue: 5000 }
            ];
            
            localStorage.setItem('sellOrders', JSON.stringify(testSellOrders));
            
            // Simulate buy orders table
            const buyOrdersTable = document.getElementById('buy-orders-table');
            if (buyOrdersTable) {
                buyOrdersTable.innerHTML = testBuyOrders.map(order => `
                    <tr>
                        <td>BUY</td>
                        <td>${order.symbol}</td>
                        <td>Test ETF</td>
                        <td>$${order.price}</td>
                        <td>10%</td>
                        <td>${order.shares}</td>
                        <td>$${order.marketValue}</td>
                        <td>10%</td>
                    </tr>
                `).join('');
            }
            
            // Run the analysis
            analyzeWashSaleViolations();
            
            console.log('Test completed. Check wash sale results section.');
        }

        // Make test function available globally for console testing
        window.testWashSaleDetection = testWashSaleDetection;
    </script>
    </div> <!-- End content-area -->
</body>
</html>