<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Rebalancing - Buy Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .refresh-spin {
            animation: spin 1s linear infinite;
        }

        /* Compact Layout Overrides */
        .text-xs { font-size: 0.6rem; line-height: 0.75rem; }
        .text-sm { font-size: 0.65rem; line-height: 0.85rem; }
        .text-base { font-size: 0.75rem; line-height: 0.95rem; }
        .text-lg { font-size: 0.8rem; line-height: 1rem; }
        .text-xl { font-size: 0.85rem; line-height: 1.1rem; }
        .text-2xl { font-size: 0.95rem; line-height: 1.2rem; }
        .text-3xl { font-size: 1.1rem; line-height: 1.3rem; }
        .text-4xl { font-size: 1.25rem; line-height: 1.4rem; }
        
        .p-2 { padding: 0.35rem; }
        .p-3 { padding: 0.5rem; }
        .p-4 { padding: 0.6rem; }
        .p-6 { padding: 0.8rem; }
        .p-8 { padding: 1rem; }
        
        .py-1 { padding-top: 0.15rem; padding-bottom: 0.15rem; }
        .py-2 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-3 { padding-top: 0.4rem; padding-bottom: 0.4rem; }
        .py-4 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-8 { padding-top: 1rem; padding-bottom: 1rem; }
        
        .px-3 { padding-left: 0.4rem; padding-right: 0.4rem; }
        .px-4 { padding-left: 0.6rem; padding-right: 0.6rem; }
        .px-6 { padding-left: 0.8rem; padding-right: 0.8rem; }
        
        .mb-2 { margin-bottom: 0.3rem; }
        .mb-3 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 0.6rem; }
        .mb-6 { margin-bottom: 0.8rem; }
        .mb-8 { margin-bottom: 1rem; }
        
        .mt-1 { margin-top: 0.15rem; }
        .mt-2 { margin-top: 0.3rem; }
        .mt-4 { margin-top: 0.6rem; }
        .mt-8 { margin-top: 1rem; }
        
        .gap-4 { gap: 0.6rem; }
        .gap-8 { gap: 1rem; }
        
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.6rem; }
        
        /* Table specific compact styling */
        table th, table td { 
            padding: 0.4rem 0.6rem !important; 
            font-size: 0.65rem !important;
            line-height: 0.85rem !important;
        }
        
        /* Button compact styling */
        button { 
            padding: 0.4rem 0.8rem !important; 
            font-size: 0.7rem !important;
        }
        
        /* Input compact styling */
        input, select { 
            padding: 0.35rem !important; 
            font-size: 0.65rem !important;
        }
        
        /* Container max width adjustment for better space usage */
        .max-w-7xl { max-width: 95vw; }
        
        /* Reduce card padding */
        .rounded-xl { padding: 0.8rem !important; }

        /* Navigation Styles */
        .nav-link {
            position: relative;
            overflow: hidden;
        }

        .nav-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .nav-link.active {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mobile-nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Navigation Bar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 mb-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Brand -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="AWM-Logo.png" alt="AWM Portfolio Rebalancer" class="h-8 w-auto mr-3">
                            <h1 class="text-lg font-bold text-gray-900 whitespace-nowrap">Portfolio Rebalancer</h1>
                        </div>
                    </div>
                    
                    <!-- Navigation Links -->
                    <div class="hidden md:flex items-center">
                        <div class="flex items-center space-x-6">
                            <a href="index.html" class="nav-link text-gray-600 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Tax Harvesting
                            </a>
                            <a href="model-portfolios.html" class="nav-link text-gray-600 hover:text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Model Portfolios
                            </a>
                            <a href="buy-orders.html" class="nav-link bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center hover:bg-green-200 transition-colors duration-200 whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Buy Orders
                            </a>
                            <a href="price-manager.html" class="nav-link text-gray-600 hover:text-teal-600 hover:bg-teal-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Price Manager
                            </a>
                            <a href="report.html" class="nav-link text-gray-600 hover:text-orange-600 hover:bg-orange-50 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center whitespace-nowrap">
                                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Reports
                            </a>
                        </div>
                    </div>
                    
                    <!-- Mobile menu button -->
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="text-gray-600 hover:text-gray-900 focus:outline-none focus:text-gray-900 p-2 rounded-md hover:bg-gray-100 transition-colors duration-200">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile menu -->
                <div id="mobile-menu" class="md:hidden hidden transition-all duration-300 ease-in-out">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-gray-50 rounded-lg mt-2 shadow-lg border border-gray-200">
                        <a href="index.html" class="mobile-nav-link text-gray-600 hover:text-blue-600 hover:bg-blue-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Tax Harvesting
                        </a>
                        <a href="model-portfolios.html" class="mobile-nav-link text-gray-600 hover:text-purple-600 hover:bg-purple-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Model Portfolios
                        </a>
                        <a href="buy-orders.html" class="mobile-nav-link bg-green-100 text-green-700 block px-3 py-2 rounded-md text-base font-medium hover:bg-green-200 transition-colors duration-200">
                            Buy Orders
                        </a>
                        <a href="price-manager.html" class="mobile-nav-link text-gray-600 hover:text-teal-600 hover:bg-teal-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Price Manager
                        </a>
                        <a href="report.html" class="mobile-nav-link text-gray-600 hover:text-orange-600 hover:bg-orange-50 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Reports
                        </a>
                    </div>
                </div>
            </div>
        </nav>
                            Tax Harvesting
                        </a>
                        <a href="model-portfolios.html" class="mobile-nav-link text-gray-600 hover:text-purple-600 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Model Portfolios
                        </a>
                        <a href="buy-orders.html" class="mobile-nav-link bg-green-100 text-green-700 block px-3 py-2 rounded-md text-base font-medium">
                            Buy Orders
                        </a>
                        <a href="price-manager.html" class="mobile-nav-link text-gray-600 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Price Manager
                        </a>
                        <a href="report.html" class="mobile-nav-link text-gray-600 hover:text-orange-600 block px-3 py-2 rounded-md text-base font-medium transition-colors duration-200">
                            Reports
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Breadcrumb -->
        <div class="breadcrumb max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <a href="index.html">Home</a>
            <span class="breadcrumb-separator">â€º</span>
            <span class="text-gray-900 font-medium">Buy Orders</span>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Portfolio Rebalancing - Buy Orders</h1>
            <p class="text-md text-gray-600 mt-2">Generate buy orders to invest cash from sell orders into your target portfolio allocation.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">1. Portfolio Setup</h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
                        <input type="text" id="clientName" placeholder="John Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                    <div>
                        <label for="custodian" class="block text-sm font-medium text-gray-700">Custodian</label>
                        <input type="text" id="custodian" placeholder="Fidelity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="accountNumber" class="block text-sm font-medium text-gray-700">Account Number</label>
                    <input type="text" id="accountNumber" placeholder="Enter Account Number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                </div>

                <div class="mb-4">
                    <label for="cashAvailable" class="block text-sm font-medium text-gray-700">Total Cash Available</label>
                    <input type="number" id="cashAvailable" placeholder="50000.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                    <p class="text-xs text-gray-500 mt-1">Total cash from sell orders or available for investment</p>
                </div>

                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Cash Management</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="cashReservePercent" class="block text-sm font-medium text-gray-700">Portfolio Cash Allocation % <span class="text-red-500">*</span></label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <input type="number" id="cashReservePercent" placeholder="1.0" step="0.1" min="0" max="50" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 pr-8">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <span class="text-gray-500 sm:text-sm">%</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Required: % of total cash to allocate to cash position</p>
                        </div>
                        <div>
                            <label for="cashReserveDollar" class="block text-sm font-medium text-gray-700">Additional Fixed Reserve (Optional)</label>
                            <div class="mt-1 relative rounded-md shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">$</span>
                                </div>
                                <input type="number" id="cashReserveDollar" placeholder="0" step="100" min="0" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 pl-7">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Optional: Additional fixed dollar amount to reserve</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Total cash reserved = Portfolio Cash Allocation % + Additional Fixed Reserve</p>
                </div>

                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label for="portfolioSelect" class="block text-sm font-medium text-gray-700">Select Model Portfolio</label>
                        <button id="refreshModelsBtn" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 flex items-center">
                            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                    <select id="portfolioSelect" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 mb-3">
                        <option value="">Select a model portfolio...</option>
                    </select>
                    
                    <div class="text-center text-sm text-gray-500 mb-3">OR</div>
                    
                    <label for="portfolioFile" class="block text-sm font-medium text-gray-700 mb-2">Upload Custom Portfolio CSV</label>
                    <input type="file" id="portfolioFile" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors duration-200 cursor-pointer">
                    <p id="portfolio-file-name" class="text-xs text-gray-500 mt-1"></p>
                    <p class="text-xs text-gray-500 mt-2">CSV should contain: Model, Symbol, Name, Price, Target Percent</p>
                </div>
            </div>

            <!-- Generate Section -->
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">2. Generate Buy Orders</h2>
                <p class="text-sm text-gray-600 mb-4">The system will calculate whole share quantities based on your target allocation percentages.</p>
                
                <div class="flex flex-col space-y-4">
                    <button id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-all duration-200 shadow-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Generate Buy Orders
                    </button>
                    <button id="exportBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md flex items-center justify-center hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" />
                        </svg>
                        Export Buy Orders CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="mt-8 bg-white p-6 rounded-xl shadow-md border border-gray-200 hidden">
            <div id="loader" class="flex justify-center items-center h-40 hidden">
                <div class="loader"></div>
                <p class="ml-4 text-gray-600">Calculating optimal buy orders...</p>
            </div>
            <div id="buy-orders">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">3. Recommended Buy Orders</h2>
                <div id="summary" class="mb-6 p-4 bg-gray-100 rounded-lg grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Target %</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Shares to Buy</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Investment Amount</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actual %</th>
                            </tr>
                        </thead>
                        <tbody id="buy-orders-table" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="no-orders-msg" class="text-center text-gray-500 py-8 hidden">No buy orders generated. Please check your inputs.</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const portfolioFileInput = document.getElementById('portfolioFile');
        const portfolioFileNameDisplay = document.getElementById('portfolio-file-name');
        const portfolioSelect = document.getElementById('portfolioSelect');
        const refreshModelsBtn = document.getElementById('refreshModelsBtn');
        const generateBtn = document.getElementById('generateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const buyOrdersDiv = document.getElementById('buy-orders');
        const buyOrdersTable = document.getElementById('buy-orders-table');
        const summaryDiv = document.getElementById('summary');
        const noOrdersMsg = document.getElementById('no-orders-msg');

        let portfolioData = [];
        let lastBuyOrders = [];
        let lastSummaryData = {};

        // --- Event Listeners ---
        portfolioFileInput.addEventListener('change', handlePortfolioFileUpload);
        portfolioSelect.addEventListener('change', handlePortfolioSelection);
        refreshModelsBtn.addEventListener('click', refreshModelPortfolios);
        generateBtn.addEventListener('click', handleGeneration);
        exportBtn.addEventListener('click', handleExport);

        // Check for transferred data from tax harvesting page
        window.addEventListener('load', handleTransferredData);
        
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const mobileMenuButton = document.getElementById('mobile-menu-button');
                const mobileMenu = document.getElementById('mobile-menu');
                
                if (mobileMenuButton && mobileMenu) {
                    mobileMenuButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        mobileMenu.classList.toggle('hidden');
                        console.log('Mobile menu toggled');
                    });
                    console.log('Mobile menu initialized successfully');
                } else {
                    console.error('Mobile menu elements not found:', {
                        button: !!mobileMenuButton,
                        menu: !!mobileMenu
                    });
                }
            } catch (error) {
                console.error('Navigation initialization error:', error);
            }
        });

        // Load model portfolios on page load
        window.addEventListener('load', refreshModelPortfolios);

        // Check for centralized prices and show notification
        window.addEventListener('load', () => {
            const savedPrices = localStorage.getItem('centralizedPrices');
            if (savedPrices) {
                try {
                    const pricesData = JSON.parse(savedPrices);
                    const symbolCount = Object.keys(pricesData).length;
                    if (symbolCount > 0) {
                        showNotification(`Using centralized prices for ${symbolCount} symbols from Price Manager`, 'info');
                    }
                } catch (error) {
                    console.warn('Error loading centralized prices:', error);
                }
            }
        });

        // Dynamic model portfolios data - loaded from CSV files
        let modelPortfolios = {};

        // Function to load all model portfolios from data/models/ directory
        async function loadModelPortfolios() {
            const modelFiles = [
                '100-0.csv',
                '50_50__Tax_Aware_8-1-2025.csv',
                '80-20.csv',
                'All Equity.csv',
                'Fixed-Income (Tax Aware).csv',
                'Fixed-Income.csv',
                'Tactical Equity.csv'
            ];

            modelPortfolios = {}; // Clear existing data

            for (const filename of modelFiles) {
                try {
                    console.log(`Attempting to load: ../data/models/${filename}`);
                    const response = await fetch(`../data/models/${filename}`);
                    console.log(`Response for ${filename}:`, response.status, response.ok);
                    if (response.ok) {
                        const csvText = await response.text();
                        // Just store the filename and a display name for the dropdown
                        const displayName = filename.replace('.csv', '').replace(/_/g, ' ');
                        modelPortfolios[filename] = displayName;
                        console.log(`Successfully loaded portfolio: ${filename} -> ${displayName}`);
                    } else {
                        console.warn(`Failed to load ${filename}: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.warn(`Could not load model portfolio: ${filename}`, error);
                }
            }
            console.log('Final modelPortfolios:', modelPortfolios);
        }

        // --- Functions ---
        async function refreshModelPortfolios() {
            const refreshIcon = refreshModelsBtn.querySelector('svg');
            const refreshText = refreshModelsBtn.querySelector('span') || refreshModelsBtn;
            
            try {
                // Show loading state
                refreshIcon.classList.add('refresh-spin');
                refreshModelsBtn.disabled = true;
                
                // Load model portfolios from CSV files
                await loadModelPortfolios();
                
                // Clear current options except the first one
                portfolioSelect.innerHTML = '<option value="">Select a model portfolio...</option>';
                
                // Add available model portfolios
                for (const [filename, displayName] of Object.entries(modelPortfolios)) {
                    const option = document.createElement('option');
                    option.value = filename;
                    option.textContent = displayName;
                    portfolioSelect.appendChild(option);
                }
                
                // Small delay to show the refresh animation
                await new Promise(resolve => setTimeout(resolve, 500));
                
                showNotification('Model portfolios refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing model portfolios:', error);
                showNotification('Error refreshing model portfolios', 'error');
            } finally {
                // Remove loading state
                refreshIcon.classList.remove('refresh-spin');
                refreshModelsBtn.disabled = false;
            }
        }

        async function handlePortfolioSelection(event) {
            const selectedFile = event.target.value;
            if (!selectedFile) {
                portfolioData = [];
                portfolioFileInput.value = '';
                portfolioFileNameDisplay.textContent = '';
                return;
            }

            try {
                // Load the selected model portfolio
                console.log(`Attempting to load: ../data/models/${selectedFile}`);
                const response = await fetch(`../data/models/${selectedFile}`);
                console.log(`Response for ${selectedFile}:`, response.status, response.ok);
                if (!response.ok) {
                    throw new Error(`Failed to load ${selectedFile}: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log(`CSV content for ${selectedFile}:`, csvText.substring(0, 200) + '...');
                portfolioData = parsePortfolioCSVWithLogging(csvText);
                
                // Clear file input and update display
                portfolioFileInput.value = '';
                portfolioFileNameDisplay.textContent = `Selected model: ${modelPortfolios[selectedFile]}`;
                
                showNotification(`Loaded model portfolio: ${modelPortfolios[selectedFile]}`, 'success');
                console.log('Loaded Model Portfolio Data:', portfolioData);
            } catch (error) {
                console.error('Error loading model portfolio:', error);
                showNotification(`Error loading model portfolio: ${error.message}`, 'error');
                portfolioSelect.value = '';
                portfolioData = [];
            }
        }

        function handlePortfolioFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                portfolioFileNameDisplay.textContent = '';
                return;
            }
            
            // Clear model portfolio selection when uploading custom file
            portfolioSelect.value = '';
            
            portfolioFileNameDisplay.textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                portfolioData = parsePortfolioCSV(e.target.result);
                console.log('Parsed Portfolio Data:', portfolioData);
            };
            reader.readAsText(file);
        }

        // Function to get centralized price for a symbol
        function getCentralizedPrice(symbol) {
            const savedPrices = localStorage.getItem('centralizedPrices');
            if (savedPrices) {
                try {
                    const pricesData = JSON.parse(savedPrices);
                    if (pricesData[symbol] && pricesData[symbol].price > 0) {
                        return pricesData[symbol].price;
                    }
                } catch (error) {
                    console.warn('Error loading centralized prices:', error);
                }
            }
            return null;
        }

        function parsePortfolioCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];
            
            const header = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            console.log('CSV Header:', header);
            
            // Find column indices with more flexible matching
            const symbolIndex = header.findIndex(h => h.includes('symbol') || h.includes('ticker'));
            const nameIndex = header.findIndex(h => h.includes('name') || h.includes('description') || h.includes('security'));
            const priceIndex = header.findIndex(h => h.includes('price') || h.includes('value') || h.includes('cost'));
            const targetPercentIndex = header.findIndex(h => 
                (h.includes('target') && h.includes('percent')) || 
                h.includes('weight') || 
                h.includes('allocation') || 
                h.includes('%')
            );
            
            console.log('Column indices:', { symbolIndex, nameIndex, priceIndex, targetPercentIndex });
            
            if (symbolIndex === -1 || priceIndex === -1 || targetPercentIndex === -1) {
                console.error('CSV parsing failed - missing required columns:', {
                    symbolIndex, nameIndex, priceIndex, targetPercentIndex,
                    headers: header
                });
                alert('CSV must contain Symbol, Price, and Target Percent/Weight columns. Check console for details.');
                return [];
            }

            return lines.slice(1).map(line => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return null;
                
                const values = trimmedLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const symbol = values[symbolIndex]?.trim().replace(/"/g, '');
                const name = values[nameIndex]?.trim().replace(/"/g, '') || '';
                const priceStr = values[priceIndex]?.trim().replace(/[$\s,"]/g, '');
                const targetPercentStr = values[targetPercentIndex]?.trim().replace(/[%\s,"]/g, '');
                
                if (!symbol || symbol === 'Symbol') return null;
                
                let price = parseFloat(priceStr) || 0;
                
                // Use centralized price if available (overrides CSV price)
                const centralizedPrice = getCentralizedPrice(symbol);
                if (centralizedPrice !== null) {
                    price = centralizedPrice;
                    console.log(`Using centralized price for ${symbol}: $${price}`);
                }
                
                const targetPercent = parseFloat(targetPercentStr) || 0;
                
                console.log('Parsed item:', { symbol, name, price, targetPercent });
                
                return {
                    symbol: symbol,
                    name: name,
                    price: price,
                    targetPercent: targetPercent
                };
            }).filter(item => {
                if (!item) return false;
                
                // Allow items with valid symbols and prices, even if target percent is 0
                const isValid = item.symbol && item.symbol !== '' && item.price >= 0;
                
                if (!isValid) {
                    console.warn('Filtered out invalid item:', item);
                }
                
                if (item.targetPercent === 0) {
                    console.warn('Warning: Item has 0% target allocation:', item.symbol);
                }
                
                return isValid;
            });
        }

        // Add final logging to parsePortfolioCSV
        function parsePortfolioCSVWithLogging(csvText) {
            const result = parsePortfolioCSV(csvText);
            console.log('Final parsed portfolio data:', result);
            console.log('Number of valid holdings:', result.length);
            return result;
        }

        function handleTransferredData() {
            const transferData = localStorage.getItem('taxHarvestingTransfer');
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    
                    // Auto-fill the form with transferred data
                    if (data.cashFromSales) {
                        document.getElementById('cashAvailable').value = data.cashFromSales.toFixed(2);
                    }
                    if (data.clientName) {
                        document.getElementById('clientName').value = data.clientName;
                    }
                    if (data.custodian) {
                        document.getElementById('custodian').value = data.custodian;
                    }
                    if (data.accountNumber) {
                        document.getElementById('accountNumber').value = data.accountNumber;
                    }
                    
                    // Show a notification
                    showNotification(`Transferred $${data.cashFromSales.toLocaleString()} from tax harvesting sales`, 'success');
                    
                    // Clear the transfer data
                    localStorage.removeItem('taxHarvestingTransfer');
                } catch (error) {
                    console.error('Error parsing transfer data:', error);
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    ${message}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function handleModelPortfolioTransfer() {
            const transferData = localStorage.getItem('modelPortfolioTransfer');
            if (transferData) {
                try {
                    const data = JSON.parse(transferData);
                    
                    // Set the portfolio data
                    portfolioData = data.portfolioData;
                    
                    // Update the file display
                    portfolioFileNameDisplay.textContent = `Loaded: ${data.portfolioName} (${portfolioData.length} holdings)`;
                    
                    // Show notification
                    showNotification(`Loaded portfolio "${data.portfolioName}" from Model Portfolios`, 'success');
                    
                    // Clear the transfer data
                    localStorage.removeItem('modelPortfolioTransfer');
                } catch (error) {
                    console.error('Error parsing model portfolio transfer data:', error);
                }
            }
        }

        function calculateCashReserves(totalCash) {
            const reservePercent = parseFloat(document.getElementById('cashReservePercent').value) || 0;
            const reserveDollar = parseFloat(document.getElementById('cashReserveDollar').value) || 0;
            
            const percentReserve = (totalCash * reservePercent) / 100;
            const dollarReserve = reserveDollar;
            
            // Add both reserves together (not take the larger)
            const totalReserve = percentReserve + dollarReserve;
            
            return {
                totalReserve: totalReserve,
                percentReserve: percentReserve,
                dollarReserve: dollarReserve,
                reservePercent: reservePercent,
                availableForInvestment: Math.max(0, totalCash - totalReserve)
            };
        }

        function handleGeneration() {
            const totalCash = parseFloat(document.getElementById('cashAvailable').value);
            const reservePercent = parseFloat(document.getElementById('cashReservePercent').value);
            
            if (!totalCash || totalCash <= 0) {
                alert('Please enter a valid cash amount available for investment.');
                return;
            }
            
            if (isNaN(reservePercent) || reservePercent < 0) {
                alert('Please enter a valid Portfolio Cash Allocation percentage (0 or greater).');
                return;
            }
            
            if (portfolioData.length === 0) {
                console.error('Portfolio data is empty:', portfolioData);
                console.error('Selected portfolio:', portfolioSelect.value);
                alert('The selected model portfolio appears to be empty or invalid. This may be because all target percentages are 0%. Please check the CSV file or upload a custom portfolio with valid target percentages.');
                return;
            }
            
            // Check if all target percentages are zero
            const hasValidTargets = portfolioData.some(item => item.targetPercent > 0);
            if (!hasValidTargets) {
                alert('Warning: All target percentages in the selected portfolio are 0%. This will not generate any buy orders. Please select a different portfolio or upload a custom CSV with valid target percentages.');
                return;
            }
            
            console.log('Portfolio data loaded successfully:', portfolioData.length, 'holdings');
            
            // Calculate cash reserves
            const reserves = calculateCashReserves(totalCash);
            const cashAvailable = reserves.availableForInvestment;
            
            if (cashAvailable <= 0) {
                alert('No cash available for investment after reserves. Please reduce your cash reserve amounts.');
                return;
            }
            
            // Validate that target percentages add up to reasonable amount
            const totalTargetPercent = portfolioData.reduce((sum, item) => sum + item.targetPercent, 0);
            if (totalTargetPercent < 90 || totalTargetPercent > 110) {
                alert(`Warning: Target percentages sum to ${totalTargetPercent.toFixed(1)}%. Expected around 100%.`);
            }
            
            resultsContainer.classList.remove('hidden');
            loader.classList.remove('hidden');
            buyOrdersDiv.classList.add('hidden');
            exportBtn.classList.add('hidden');

            setTimeout(() => {
                lastBuyOrders = generateBuyOrders(cashAvailable, reserves);
                displayBuyOrders(lastBuyOrders, totalCash, reserves);
                loader.classList.add('hidden');
                buyOrdersDiv.classList.remove('hidden');
                if(lastBuyOrders.length > 0) {
                    exportBtn.classList.remove('hidden');
                    // Auto-save data for report
                    saveBuyOrdersReportData();
                }
            }, 500);
        }

        function generateBuyOrders(cashAvailable, reserves) {
            const buyOrders = [];
            let remainingCash = cashAvailable;
            let totalInvested = 0;
            
            // Sort by target percentage descending to prioritize larger allocations
            const sortedPortfolio = [...portfolioData].sort((a, b) => b.targetPercent - a.targetPercent);
            
            // First pass: calculate target amounts and whole shares
            for (const item of sortedPortfolio) {
                const targetAmount = (cashAvailable * item.targetPercent) / 100;
                const wholeSharesToBuy = Math.floor(targetAmount / item.price);
                const actualInvestment = wholeSharesToBuy * item.price;
                
                if (wholeSharesToBuy > 0 && actualInvestment <= remainingCash) {
                    const actualPercent = (actualInvestment / cashAvailable) * 100;
                    
                    buyOrders.push({
                        symbol: item.symbol,
                        name: item.name,
                        price: item.price,
                        targetPercent: item.targetPercent,
                        sharesToBuy: wholeSharesToBuy,
                        investmentAmount: actualInvestment,
                        actualPercent: actualPercent
                    });
                    
                    remainingCash -= actualInvestment;
                    totalInvested += actualInvestment;
                }
            }
            
            // Second pass: try to use remaining cash for additional shares
            if (remainingCash > 0) {
                for (const order of buyOrders) {
                    const additionalShares = Math.floor(remainingCash / order.price);
                    if (additionalShares > 0) {
                        const additionalInvestment = additionalShares * order.price;
                        order.sharesToBuy += additionalShares;
                        order.investmentAmount += additionalInvestment;
                        order.actualPercent = (order.investmentAmount / cashAvailable) * 100;
                        remainingCash -= additionalInvestment;
                        totalInvested += additionalInvestment;
                        
                        if (remainingCash < Math.min(...portfolioData.map(p => p.price))) {
                            break;
                        }
                    }
                }
            }
            
            lastSummaryData = {
                totalInvested,
                remainingCash,
                cashAvailable,
                orderCount: buyOrders.length,
                reserves: reserves
            };
            
            return buyOrders;
        }

        function displayBuyOrders(buyOrders, totalCash, reserves) {
            buyOrdersTable.innerHTML = '';
            noOrdersMsg.classList.toggle('hidden', buyOrders.length > 0);

            const formatCurrency = (num) => num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            const formatPercent = (num) => num.toFixed(2) + '%';

            buyOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">BUY</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.symbol}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${formatCurrency(order.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${formatPercent(order.targetPercent)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900">${order.sharesToBuy.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium text-green-600">${formatCurrency(order.investmentAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${formatPercent(order.actualPercent)}</td>
                `;
                buyOrdersTable.appendChild(row);
            });

            // Update summary
            const { totalInvested, remainingCash, orderCount } = lastSummaryData;
            const cashAvailable = reserves.availableForInvestment;
            const utilizationPercent = (totalInvested / cashAvailable) * 100;
            const totalRemainingCash = remainingCash + reserves.totalReserve;

            let summaryHTML = `
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Cash Available</p>
                    <p class="text-xl font-bold text-gray-800">${formatCurrency(totalCash)}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Invested</p>
                    <p class="text-xl font-bold text-green-600">${formatCurrency(totalInvested)}</p>
                    <p class="text-xs text-gray-500">(${orderCount} orders)</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Total Cash Remaining</p>
                    <p class="text-xl font-bold ${totalRemainingCash > 1000 ? 'text-blue-600' : 'text-gray-600'}">${formatCurrency(totalRemainingCash)}</p>
                    <p class="text-xs text-gray-500">(${utilizationPercent.toFixed(1)}% of investable cash used)</p>
                </div>
            `;

            // Add reserve breakdown if reserves are set
            if (reserves.totalReserve > 0) {
                summaryHTML += `
                    <div class="col-span-full mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 mb-2">Cash Reserve Breakdown:</h4>
                        <div class="grid grid-cols-2 gap-4 text-xs text-blue-700">
                            <div>
                                <span class="font-medium">Portfolio Cash Allocation:</span> ${formatCurrency(reserves.percentReserve)} (${reserves.reservePercent}%)
                                ${reserves.dollarReserve > 0 ? `<br><span class="font-medium">Additional Fixed Reserve:</span> ${formatCurrency(reserves.dollarReserve)}` : ''}
                            </div>
                            <div>
                                <span class="font-medium">Total Reserved:</span> ${formatCurrency(reserves.totalReserve)}<br>
                                <span class="font-medium">Uninvested:</span> ${formatCurrency(remainingCash)}
                            </div>
                        </div>
                    </div>
                `;
            }

            summaryDiv.innerHTML = summaryHTML;
        }

        function handleExport() {
            if (lastBuyOrders.length === 0) {
                alert("No buy orders to export.");
                return;
            }

            // Save data for report
            saveBuyOrdersReportData();

            const accountNumber = document.getElementById('accountNumber').value || 'N/A';
            const clientName = document.getElementById('clientName').value || 'N/A';
            const custodian = document.getElementById('custodian').value || 'N/A';
            
            const headers = [
                "Account Number", "Client Name", "Custodian", "Action", "Symbol", 
                "Security Name", "Quantity", "Price", "Total Investment", 
                "Target Percent", "Actual Percent", "Cash Reserves", "Remaining Cash"
            ];

            const { reserves } = lastSummaryData;
            const rows = lastBuyOrders.map((order, index) => {
                return [
                    accountNumber,
                    `"${clientName}"`,
                    `"${custodian}"`,
                    "Buy",
                    `"${order.symbol}"`,
                    `"${order.name}"`,
                    order.sharesToBuy,
                    order.price.toFixed(2),
                    order.investmentAmount.toFixed(2),
                    order.targetPercent.toFixed(2),
                    order.actualPercent.toFixed(2),
                    index === 0 ? reserves.totalReserve.toFixed(2) : '', // Only show reserves on first row
                    index === 0 ? lastSummaryData.remainingCash.toFixed(2) : '' // Only show remaining cash on first row
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `buy_orders_${accountNumber}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveBuyOrdersReportData() {
            const totalCash = parseFloat(document.getElementById('cashAvailable').value) || 0;
            const { totalInvested, remainingCash, reserves } = lastSummaryData;

            // Determine portfolio source
            let portfolioSource = 'None';
            let portfolioName = '';
            
            if (portfolioData.length > 0) {
                const selectedPortfolio = portfolioSelect.value;
                if (selectedPortfolio) {
                    portfolioSource = 'Model Portfolio';
                    portfolioName = modelPortfolios[selectedPortfolio] || selectedPortfolio;
                } else {
                    portfolioSource = 'Custom Upload';
                    portfolioName = portfolioFileNameDisplay.textContent.replace('Selected: ', '') || 'Custom Portfolio';
                }
            }

            const reportData = {
                totalCash: totalCash,
                totalInvested: totalInvested,
                remainingCash: remainingCash,
                reserves: reserves,
                orders: lastBuyOrders,
                portfolioSource: portfolioSource,
                portfolioName: portfolioName,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('buyOrdersReport', JSON.stringify(reportData));
        }
    </script>
</body>
</html>