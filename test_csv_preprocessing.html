<!DOCTYPE html>
<html>
<head>
    <title>CSV Preprocessing Test</title>
</head>
<body>
    <h1>CSV Preprocessing Test</h1>
    <input type="file" id="fileInput" accept=".csv">
    <br><br>
    <textarea id="originalCSV" rows="20" cols="80" placeholder="Original CSV will appear here..."></textarea>
    <br><br>
    <textarea id="processedCSV" rows="20" cols="80" placeholder="Processed CSV will appear here..."></textarea>
    
    <script>
        // Debug logging function
        const DEBUG = {
            log: (category, message, data) => {
                console.log(`[${category}] ${message}`, data || '');
            }
        };

        function preprocessCostBasisCSV(csvText) {
            DEBUG.log('CSV_PREPROCESS', 'Starting CSV preprocessing');
            
            const lines = csvText.trim().split('\n');
            if (lines.length < 8) {
                DEBUG.log('CSV_PREPROCESS', 'Not template format - insufficient lines for template');
                return csvText;
            }
            
            // Check if this matches the template format
            // Template format indicators:
            // - Line 1: Account number (just digits)
            // - Line 2: Export record count
            // - Line 3: "CostBasis for Single Account as of..."
            // - Line 8: Headers starting with "Symbol,Name,Acquired/Opened..."
            
            const line1 = lines[0].trim();
            const line2 = lines[1].trim();
            const line3 = lines[2].trim();
            const line8 = lines[7].trim();
            
            const isTemplateFormat = (
                /^\d+$/.test(line1) && // Line 1 is just digits (account number)
                /\d+\s+Records exported/.test(line2) && // Line 2 mentions records exported
                line3.includes('CostBasis for Single Account') && // Line 3 has the title
                line8.toLowerCase().includes('symbol') && line8.toLowerCase().includes('name') // Line 8 has headers
            );
            
            if (!isTemplateFormat) {
                DEBUG.log('CSV_PREPROCESS', 'Not template format - keeping original CSV');
                return csvText;
            }
            
            DEBUG.log('CSV_PREPROCESS', 'Template format detected - removing rows 1-7 and columns 11-14');
            
            // Remove rows 1-7 (keep from line 8 onwards, which is index 7)
            const filteredLines = lines.slice(7);
            
            // Remove columns 11-14 from each line
            const processedLines = filteredLines.map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                // Keep columns 0-10, skip columns 11-14 (indices 10, 11, 12, 13), keep the rest
                const filteredValues = values.filter((value, index) => {
                    return index < 10 || index > 13;
                });
                
                return filteredValues.join(',');
            });
            
            const processedCSV = processedLines.join('\n');
            DEBUG.log('CSV_PREPROCESS', `Processed CSV: removed 7 header rows and columns 11-14`);
            DEBUG.log('CSV_PREPROCESS', `Original lines: ${lines.length}, Processed lines: ${processedLines.length}`);
            
            return processedCSV;
        }

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const originalCSV = e.target.result;
                const processedCSV = preprocessCostBasisCSV(originalCSV);
                
                document.getElementById('originalCSV').value = originalCSV;
                document.getElementById('processedCSV').value = processedCSV;
                
                console.log('Original CSV length:', originalCSV.length);
                console.log('Processed CSV length:', processedCSV.length);
                console.log('Files are different:', originalCSV !== processedCSV);
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
